<html>
  <!-- Adding a data chart using Chart.js -->

  <head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.3.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@1.27.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@2.0.0"></script>
  </head>

  <body onload="javascript:init()">
    <!-- Adding a slider for controlling data rate -->
    <div>
      <input
        type="range"
        min="1"
        max="10"
        value="5"
        id="dataRateSlider"
        oninput="sendDataRate()"
      />
      <label for="dataRateSlider" id="dataRateLabel">Rate: 0.2Hz</label>
    </div>
    <hr />
    <div>
      <canvas id="line-chart" width="800" height="450"></canvas>
    </div>
    <!-- Adding a websocket to the client (webpage) -->
    <script>
      var webSocket, dataPlot;
      var timeSync = 0;
      function init() {
        webSocket = new WebSocket(
          "ws://" + window.location.hostname + ":80/ws/api"
        );
        dataPlot = new Chart(document.getElementById("line-chart"), {
          type: "line",
          data: {
            datasets: [
              {
                borderColor: "rgb(54, 162, 235)",
                fill: false,
                pointRadius: 0,
                data: [],
                yAxisID: "y",
              },
              {
                backgroundColor: "rgba(255, 99, 132, 0.1)",
                borderColor: "rgb(255, 99, 132)",
                fill: true,
                pointRadius: 0,
                data: [],
                yAxisID: "y1",
              },
            ],
          },
          options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: "index",
              intersect: false,
            },
            stacked: false,
            plugins: {
              // Change options for ALL axes of THIS CHART
              streaming: {
                duration: 20000,
                refresh: 25,
              },
              tooltip: {
                enabled: false,
              },
              legend: {
                display: false,
              },
            },
            scales: {
              x: {
                type: "realtime",
              },
              y: {
                type: "linear",
                title: {
                  display: true,
                  text: "Position [mm]",
                  color: "rgb(54, 162, 235)",
                  font: {
                    size: 16,
                    weight: "bold",
                  },
                },
                position: "left",
                min: 0,
                max: 150,
                ticks: {
                  stepSize: 150 / 6,
                },
              },
              y1: {
                type: "linear",
                title: {
                  display: true,
                  text: "Speed [mm/s]",
                  color: "rgb(255, 99, 132)",
                  font: {
                    size: 16,
                    weight: "bold",
                  },
                },
                position: "left",
                suggestedMin: -150,
                suggestedMax: 150,
                ticks: {
                  stepSize: 150 / 3,
                },
                grid: {
                  drawOnChartArea: false, // only want the grid lines for one axis to show up
                },
              },
            },
          },
        });
        webSocket.onmessage = function (event) {
          //console.log(event);
          var data = JSON.parse(event.data);
          if (timeSync == 0) {
            timeSync = Date.now() - data.time;
          }
          dataPlot.data.datasets[0].data.push({
            x: timeSync + data.time,
            y: data.position,
          });
          dataPlot.data.datasets[1].data.push({
            x: timeSync + data.time,
            y: data.speed,
          });
        };
      }
      function sendDataRate() {
        var dataRate = document.getElementById("dataRateSlider").value;
        webSocket.send(dataRate);
        dataRate = 1.0 / dataRate;
        document.getElementById("dataRateLabel").innerHTML =
          "Rate: " + dataRate.toFixed(2) + "Hz";
      }
    </script>
  </body>
</html>
